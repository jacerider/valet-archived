{"version":3,"sources":["valet.js"],"names":["$","Drupal","drupalSettings","filter","array","term","matcher","RegExp","ui","autocomplete","escapeRegex","grep","value","test","command","label","proto","prototype","initSource","_initSource","extend","isArray","this","options","source","request","response","call","behaviors","valet","attach","context","once","each","model","models","ValetModel","views","ValetView","el","find","Backbone","Model","defaults","isOpen","View","initialize","self","$input","$el","$window","window","$body","$results","down","click","toggle","bind","e","preventDefault","timeout","_","bindAll","document","keyDown","keyUp","appendTo","minLength","delay","autoFocus","search","event","addClass","clearTimeout","setTimeout","removeClass","focus","select","item","go","_renderItem","ul","length","substring","icon","append","description","_renderMenu","items","slice","index","_renderItemData","get","set","blur","off","val","attr","getData","autoComplete","on","target","closest","data","replace","location","pathname","open","cb","localStorage","JSON","parse","getItem","cache","timestamp","ajax","url","path","baseUrl","dataType","success","time","Math","floor","Date","getTime","setItem","stringify","error","xhr","ajaxOptions","thrownError","alert","status","keyCode","hotkey","modifier","is","jQuery"],"mappings":"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","file":"valet.js","sourcesContent":["/**\n * @file toolbar.js\n *\n * Defines the behavior of the Drupal administration toolbar.\n */\n(function ($, Drupal, drupalSettings) {\n\n  'use strict';\n\n  // Remap the filter functions for autocomplete to recognise the\n  // extra value \"command\". Borrowed from the wonderful coffee project.\n  var proto = $.ui.autocomplete.prototype;\n  var initSource = proto._initSource;\n\n  function filter(array, term) {\n    var matcher = new RegExp($.ui.autocomplete.escapeRegex(term), 'i');\n    return $.grep(array, function (value) {\n      return matcher.test(value.command) || matcher.test(value.label) || matcher.test(value.value);\n    });\n  }\n\n  $.extend(proto, {\n    _initSource: function () {\n      if ($.isArray(this.options.source)) {\n        this.source = function (request, response) {\n          response(filter(this.options.source, request.term));\n        };\n      }\n      else {\n        initSource.call(this);\n      }\n    }\n  });\n\n  /**\n   * Set up and bind Valet.\n   */\n  Drupal.behaviors.valet = {\n\n    attach: function (context) {\n      // Process the administrative toolbar.\n      $('body').once('valet').each(function () {\n        var model = new Drupal.valet.models.ValetModel();\n        new Drupal.valet.views.ValetView({\n          el: $(context).find('#valet'),\n          model: model\n        });\n      });\n    }\n  };\n\n  Drupal.valet = Drupal.valet || {models: {}, views: {}};\n\n  /**\n   * Backbone Model for valet.\n   */\n  Drupal.valet.models.ValetModel = Backbone.Model.extend({\n    defaults: {\n      // Indicates whether the valet is currently running.\n      isOpen: false\n    }\n  });\n\n  /**\n   * Handles valet interactions.\n   */\n  Drupal.valet.views.ValetView = Backbone.View.extend({\n\n    /**\n     * Implements Backbone Views' initialize().\n     */\n    initialize: function () {\n      var self = this;\n      this.$input = this.$el.find('.valet-input');\n      this.$window = $(window);\n      this.$body = $('body');\n      this.$results = $('#valet-results');\n      this.down = [];\n      this.$el.find('.valet-close').click(this.toggle.bind(this));\n      this.$el.find('.valet-open-link').click(function (e) {\n        e.preventDefault();\n        self.toggle();\n      });\n      this.timeout = null;\n      _.bindAll(this, 'keyDown');\n      _.bindAll(this, 'keyUp');\n      $(document).bind('keydown', this.keyDown).bind('keyup', this.keyUp);\n      $('.toolbar-icon-valet').click(function (e) {\n        e.preventDefault();\n        self.toggle();\n      });\n      // Autocomplete setup\n      this.$input.autocomplete({\n        appendTo: this.$results,\n        minLength: 1,\n        delay: 0,\n        autoFocus: true,\n        search: function (event, ui) {\n          self.$results.addClass('searching');\n        },\n        response: function (event, ui) {\n          clearTimeout(self.timeout);\n          self.timeout = setTimeout(function () {\n            self.$results.removeClass('searching');\n          }, 10);\n        },\n        // source: data,\n        focus: function (event, ui) {\n          return false;\n        },\n        select: function (event, ui) {\n          if (ui.item) {\n            self.go(ui.item.label, ui.item.value);\n            return false;\n          }\n        }\n      });\n      // Add some magical style to our results\n      this.$input.autocomplete('instance')._renderItem = function (ul, item) {\n        var value = item.value.length > 0 ? item.value : '/';\n        value = item.value.length > 85 ? item.value.substring(0, 85) + '...' : value;\n        var icon = item.icon ? '<i class=\"' + item.icon + '\"></i>' : '';\n        return $('<li></li>')\n          .append('<a>' + icon + '<strong>' + item.label + '</strong><em>' + item.description + '</em><small>' + value + '</small></a>')\n          .appendTo(ul);\n      };\n      // Limit the max results\n      this.$input.autocomplete('instance')._renderMenu = function (ul, items) {\n        var self = this;\n        items = items.slice(0, 6);\n        $.each(items, function (index, item) {\n          self._renderItemData(ul, item);\n        });\n      };\n    },\n\n    toggle: function () {\n      var self = this;\n      if (this.model.get('isOpen')) {\n        this.$el.removeClass('open');\n        this.$body.removeClass('valet-open');\n        this.model.set('isOpen', false);\n        // trick to hide input text once the search overlay closes\n        // todo: hardcoded times, should be done after transition ends\n        if (this.$input[0].value !== '') {\n          setTimeout(function () {\n            self.$el.addClass('hideInput');\n            setTimeout(function () {\n              self.$el.removeClass('hideInput');\n              self.$input[0].value = '';\n            }, 300);\n          }, 500);\n        }\n        this.$input[0].blur();\n        this.$window.off('click.valet-link');\n      }\n      else {\n        this.$input.val('').attr('disabled', false);\n        this.getData(this.autoComplete.bind(this));\n        this.$el.addClass('open');\n        this.$body.addClass('valet-open');\n        this.model.set('isOpen', true);\n        this.$input.focus();\n        // delay binding of window click.\n        setTimeout(function () {\n          self.$window.on('click.valet-link', function (e) {\n            if (!$(e.target).closest('.valet-inner').length) {\n              self.toggle();\n            }\n          });\n        }, 300);\n      }\n    },\n\n    autoComplete: function (data) {\n      this.$input.autocomplete('option', {source: data});\n    },\n\n    go: function (label, value) {\n      value = value.replace('RETURN_URL', window.location.pathname.substring(1));\n\n      if (this.down[16]) {\n        this.down[16] = false;\n        this.toggle();\n        window.open(value);\n      }\n      else {\n        this.$input.val('Loading...').attr('disabled', true);\n        window.location = value;\n      }\n    },\n\n    getData: function (cb) {\n      var self = this;\n      var data = localStorage ? JSON.parse(localStorage.getItem('valet')) : null;\n      if (data && drupalSettings.valet.cache && data.timestamp >= drupalSettings.valet.cache) {\n        return cb(data.data);\n      }\n      else {\n        self.$input.val('Loading data...').attr('disabled', true);\n        $.ajax({\n          url: drupalSettings.path.baseUrl + 'api/valet',\n          dataType: 'json',\n          success: function (data) {\n            self.$input.val('').attr('disabled', false).focus();\n            if (localStorage) {\n              var time = Math.floor(new Date().getTime() / 1000);\n              localStorage.setItem('valet', JSON.stringify({timestamp: time, data: data}));\n            }\n            return cb(data);\n          },\n          error: function (xhr, ajaxOptions, thrownError) {\n            alert(xhr.status);\n            alert(thrownError);\n            return cb(null);\n          }\n        });\n      }\n    },\n\n    keyDown: function (e) {\n      if (this.model.get('isOpen') && e.keyCode === 27) {\n        this.toggle();\n        return;\n      }\n      this.down[e.keyCode] = true;\n\n      if (this.down[drupalSettings.valet.hotkey] && this.down[drupalSettings.valet.modifier] && !$(e.target).is(':focus')) {\n        e.preventDefault();\n        this.toggle();\n      }\n    },\n\n    keyUp: function (e) {\n      this.down[e.keyCode] = false;\n    }\n\n  });\n\n}(jQuery, Drupal, drupalSettings));\n"],"sourceRoot":"/source/"}
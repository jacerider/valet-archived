"use strict";!function(e,t,i){function s(t,i){var s;if(":"===i.charAt(0)){var n=i.match(/^:[a-z]+/);n&&(i=i.replace(/^:[a-z]+ /,""),n=n[0],s=new RegExp(e.ui.autocomplete.escapeRegex(n),"i"),t=e.grep(t,function(e){return s.test(e.command)}))}return s=new RegExp(e.ui.autocomplete.escapeRegex(i),"i"),e.grep(t,function(e){return s.test(e.label)||s.test(e.value)||s.test(e.tags)})}var n=e.ui.autocomplete.prototype,o=n._initSource;e.extend(n,{_initSource:function(){e.isArray(this.options.source)?this.source=function(e,t){t(s(this.options.source,e.term))}:o.call(this)}}),t.behaviors.valet={attach:function(i){e("#valet",i).once("valet").each(function(){var i=new t.valet.models.ValetModel;new t.valet.views.ValetView({el:e(this),model:i})})}},t.valet=t.valet||{models:{},views:{}},t.valet.models.ValetModel=Backbone.Model.extend({defaults:{isOpen:!1}}),t.valet.views.ValetView=Backbone.View.extend({initialize:function(){var t=this;this.$input=this.$el.find(".valet-input"),this.$window=e(window),this.$body=e("body"),this.$results=e("#valet-results"),this.down=[],this.$el.find(".valet-close").click(this.toggle.bind(this)),this.$el.find(".valet-open-link").click(function(e){e.preventDefault(),t.toggle()}),this.timeout=null,_.bindAll(this,"keyDown"),_.bindAll(this,"keyUp"),e(document).bind("keydown",this.keyDown).bind("keyup",this.keyUp),e(".valet-trigger").click(function(e){e.preventDefault(),t.toggle()}),this.$input.autocomplete({appendTo:this.$results,minLength:1,delay:0,autoFocus:!0,search:function(e,i){t.disableMouse(),t.$results.addClass("searching")},response:function(e,i){clearTimeout(t.timeout),t.timeout=setTimeout(function(){t.$results.removeClass("searching")},10)},focus:function(t,i){return e(".ui-state-focus",t.currentTarget).removeClass("ui-state-focus"),e(".ui-state-active",t.currentTarget).closest("li").addClass("ui-state-focus"),!1},select:function(e,i){if(i.item)return t.go(i.item.label,i.item.value),!1}}),this.$input.autocomplete("instance")._renderItem=function(t,i){var s=i.value.length>0?i.value:"/";s=i.value.length>85?i.value.substring(0,85)+"...":s;var n=i.icon?'<i class="'+i.icon+'"></i>':"";return e("<li></li>").append("<a>"+n+"<strong>"+i.label+"</strong><em>"+i.description+"</em><small>"+s+"</small></a>").appendTo(t)},this.$input.autocomplete("instance")._renderMenu=function(t,i){var s=this;i=i.slice(0,6),e.each(i,function(e,i){s._renderItemData(t,i)})}},toggle:function(){var t=this;this.model.get("isOpen")?(this.enableMouse(),this.$el.removeClass("open"),this.$body.removeClass("valet-open"),this.model.set("isOpen",!1),""!==this.$input[0].value&&setTimeout(function(){t.$el.addClass("hideInput"),setTimeout(function(){t.$el.removeClass("hideInput"),t.$input[0].value=""},300)},500),this.$input[0].blur(),this.$window.off("click.valet")):(this.disableMouse(),this.getData(this.autoComplete.bind(this)),this.$el.addClass("open"),this.$body.addClass("valet-open"),this.model.set("isOpen",!0),this.$input.val("").focus(),setTimeout(function(){t.$window.on("click.valet",function(i){e(i.target).closest(".valet-inner").length||t.toggle()})},300))},autoComplete:function(e){this.$input.autocomplete("option",{source:e})},go:function(e,t){t=t.replace("RETURN_URL",window.location.pathname.substring(1)),this.down[16]?(this.down[16]=!1,this.toggle(),window.open(t)):(this.$input.val("Loading...").attr("disabled",!0),window.location=t)},getData:function(t){var s=this,n=localStorage?JSON.parse(localStorage.getItem("valet")):null;if(n&&i.valet.cache&&n.timestamp>=i.valet.cache)return t(n.data);s.$input.val("Loading data...").attr("disabled",!0),e.ajax({url:i.path.baseUrl+"api/valet",dataType:"json",success:function(e){if(s.$input.val("").attr("disabled",!1).focus(),localStorage){var i=Math.floor((new Date).getTime()/1e3);localStorage.setItem("valet",JSON.stringify({timestamp:i,data:e}))}return t(e)},error:function(e,i,s){return alert(e.status),alert(s),t(null)}})},keyDown:function(t){if(this.model.get("isOpen")&&27===t.keyCode)return void this.toggle();this.down[t.keyCode]=!0,this.down[i.valet.hotkey]&&this.down[i.valet.modifier]&&!e(t.target).is(":focus")&&(t.preventDefault(),this.toggle())},keyUp:function(e){this.down[e.keyCode]=!1},enableMouse:function(){this.$results.removeClass("valet-mouse-disabled"),this.$window.off("mousemove.valet")},disableMouse:function(){var e=this;this.$results.addClass("valet-mouse-disabled"),this.$window.on("mousemove.valet",function(){e.enableMouse()})}})}(jQuery,Drupal,drupalSettings);